#!/bin/bash
# Debug e2e tests without UI - uses verbose logging instead

set -e

# Ensure we're in the project root
cd "$(dirname "$0")/../.."

# Force headless mode
export HEADED=false
export CI=true
export DEBUG=pw:api,pw:browser

# Disable any UI mode
unset PWDEBUG

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}Error: Please specify a test file to debug${NC}"
    echo "Usage: $0 <test-file-path>"
    exit 1
fi

echo -e "${GREEN}=== Debugging E2E Test (Headless with Verbose Logging) ===${NC}"
echo -e "${YELLOW}Test file: $1${NC}"

# Enable trace for debugging
echo -e "${YELLOW}Running with trace enabled...${NC}"
timeout 300s pnpm playwright test "$1" \
    --trace=on \
    --reporter=list \
    --workers=1 \
    --repeat-each=1 \
    --retries=0 \
    --timeout=60000 || EXIT_CODE=$?

# Show trace location if test failed
if [ "${EXIT_CODE:-0}" -ne 0 ]; then
    echo -e "\n${YELLOW}=== Debug Information ===${NC}"
    echo "1. Check test output above for error details"
    echo "2. Trace files saved in: test-results/"
    echo "3. To view trace (requires local browser):"
    echo "   pnpm playwright show-trace test-results/*/trace.zip"
    echo ""
    echo "For headless debugging, focus on:"
    echo "- Console output and error messages"
    echo "- Network requests in the trace"
    echo "- Screenshots (if any) in test-results/"
fi

exit ${EXIT_CODE:-0}