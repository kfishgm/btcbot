#!/bin/bash
# Get comprehensive project understanding for the primary developer
set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}=== TriBot Project Overview ===${NC}"
echo ""

# 1. Project Type & Stack
echo -e "${CYAN}ðŸ“¦ Project Information:${NC}"
echo "â€¢ Name: TriBot - Automated Trading Bot Platform"
echo "â€¢ Type: Next.js 15 App Router + Supabase"
echo "â€¢ UI: shadcn/ui components (modern minimalist)"
echo "â€¢ Testing: Jest + Playwright (90% coverage target)"
echo ""

# 2. Current Features
echo -e "${CYAN}âœ¨ Core Features:${NC}"
echo "â€¢ Multi-timeframe Smart DCA trading (4H, 1D, 1W)"
echo "â€¢ Capital management with automatic profit retention"
echo "â€¢ Idle capital optimization via Earn integration"
echo "â€¢ Real-time monitoring dashboard"
echo "â€¢ User role system (Standard to Enterprise)"
echo ""

# 3. Design System
echo -e "${CYAN}ðŸŽ¨ Design System:${NC}"
echo "â€¢ Component Library: shadcn/ui (ALWAYS use these first)"
echo "â€¢ Color System: Semantic tokens only (bg-primary, text-secondary, etc.)"
echo "â€¢ Style: Modern minimalist - clean, functional, no clutter"
echo "â€¢ Shadows: Use shadow-sm or shadow-md (no gradients)"
echo ""

# 4. Available shadcn Components
echo -e "${CYAN}ðŸ§© Available shadcn/ui Components:${NC}"
if command -v npx &> /dev/null; then
    echo "Checking installed components..."
    # List components from the UI directory
    if [ -d "components/ui" ]; then
        ls components/ui/*.tsx 2>/dev/null | sed 's|components/ui/||g' | sed 's|\.tsx||g' | while read comp; do
            echo "  â€¢ $comp"
        done
    fi
    echo ""
    echo "To add new components: npx shadcn@latest add <component>"
else
    echo "  (npx not available - check components/ui/ directory)"
fi
echo ""

# 5. Key Patterns
echo -e "${CYAN}ðŸ“ Key Patterns to Follow:${NC}"
if [ -f "PROJECT_CONTEXT.md" ]; then
    echo "â€¢ API Routes: Try-catch with validation and proper error handling"
    echo "â€¢ Components: Always include loading and error states"
    echo "â€¢ Forms: Client + server validation with clear feedback"
    echo "â€¢ Database: Use Supabase RLS policies for security"
    echo "â€¢ Testing: Unit tests for logic, E2E for user flows"
else
    echo "  (PROJECT_CONTEXT.md not found - create it for patterns)"
fi
echo ""

# 6. Business Rules
echo -e "${CYAN}ðŸ’¼ Core Business Rules:${NC}"
echo "â€¢ Only USDT pairs (BTC/USDT, ETH/USDT, etc.)"
echo "â€¢ Spot markets only (no futures/margin)"
echo "â€¢ Every cycle must close with USDT profit"
echo "â€¢ Complete audit trail for all operations"
echo "â€¢ Automatic profit savings to Funding wallet"
echo ""

# 7. Current State Check
echo -e "${CYAN}ðŸ“Š Current Project State:${NC}"

# Check for TypeScript errors
echo -n "â€¢ TypeScript Status: "
if timeout 10s pnpm typecheck > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ No errors${NC}"
else
    echo -e "${YELLOW}âš  Has errors (run 'pnpm typecheck' for details)${NC}"
fi

# Check for lint errors
echo -n "â€¢ ESLint Status: "
if timeout 10s pnpm lint > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ No errors${NC}"
else
    echo -e "${YELLOW}âš  Has errors (run 'pnpm lint' for details)${NC}"
fi

# Check test status
echo -n "â€¢ Test Status: "
if timeout 30s pnpm test > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ All passing${NC}"
else
    echo -e "${YELLOW}âš  Some failing (run 'pnpm test' for details)${NC}"
fi

# Check for TODOs
TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" app/ components/ lib/ 2>/dev/null | wc -l || echo "0")
echo "â€¢ TODOs/FIXMEs: $TODO_COUNT found"

echo ""

# 8. Quick Reference
echo -e "${CYAN}âš¡ Quick Commands:${NC}"
echo "â€¢ npx shadcn@latest add <component> - Add UI component"
echo "â€¢ pnpm test - Run unit tests"
echo "â€¢ pnpm test:e2e:chromium - Run E2E tests"
echo "â€¢ pnpm typecheck - Check TypeScript"
echo "â€¢ pnpm lint - Check ESLint"
echo "â€¢ validate-implementation - Run all checks"
echo ""

# 9. Important Files
echo -e "${CYAN}ðŸ“„ Key Documentation:${NC}"
echo "â€¢ PROJECT_CONTEXT.md - Business context and patterns"
echo "â€¢ CLAUDE.md - Development standards"
echo "â€¢ docs/PRD.md - Product requirements"
echo "â€¢ docs/patterns/ - Code patterns to follow"
echo ""

echo -e "${GREEN}Ready to implement! Remember:${NC}"
echo "1. Use shadcn/ui components first"
echo "2. Semantic colors only (no hardcoded colors)"
echo "3. Complete implementations (no stubs/TODOs)"
echo "4. All tests must pass before completing"